package org.systemsbiology.xtandem.scoring;

import org.junit.*;
import org.systemsbiology.xtandem.*;
import org.systemsbiology.xtandem.reporting.*;
import org.systemsbiology.xtandem.testing.*;

import java.io.*;

/**
 * org.systemsbiology.xtandem.scoring.KScoreTest
 *
 * @author Steve Lewis
 * @date Mar 15, 2011
 */
public class KScoreTest
{
    public static KScoreTest[] EMPTY_ARRAY = {};
    public static Class THIS_CLASS = KScoreTest.class;

    SpectrumPeak[] XTANDEM_FINDS = {

            new SpectrumPeak(324, 0.0353294F),
            new SpectrumPeak(342, 0.0259509F),
            new SpectrumPeak(346, 0.0274517F),
            new SpectrumPeak(350, 0.0443823F),
            new SpectrumPeak(362, 0.0354596F),
            new SpectrumPeak(365, 0.0402504F),
            new SpectrumPeak(366, 0.0392302F),
            new SpectrumPeak(375, 0.0555469F),
            new SpectrumPeak(377, 0.0399954F),
            new SpectrumPeak(382, 0.0313228F),
            new SpectrumPeak(403, 0.050179F),
            new SpectrumPeak(410, 0.0392893F),
            new SpectrumPeak(413, 0.0542744F),
            new SpectrumPeak(418, 0.0517682F),
            new SpectrumPeak(420, 0.034553F),
            new SpectrumPeak(422, 0.0296339F),
            new SpectrumPeak(424, 0.0229433F),
            new SpectrumPeak(443, 0.0316624F),
            new SpectrumPeak(453, 0.0303833F),
            new SpectrumPeak(466, 0.0271248F),
            new SpectrumPeak(468, 0.0253534F),
            new SpectrumPeak(473, 0.105447F),
            new SpectrumPeak(481, 0.0224929F),
            new SpectrumPeak(482, 0.0502799F),
            new SpectrumPeak(492, 0.0416639F),
            new SpectrumPeak(493, 0.0626635F),
            new SpectrumPeak(494, 0.047523F),
            new SpectrumPeak(497, 0.0480383F),
            new SpectrumPeak(517, 0.0346736F),
            new SpectrumPeak(522, 0.0391802F),
            new SpectrumPeak(523, 0.0379739F),
            new SpectrumPeak(526, 0.0496463F),
            new SpectrumPeak(532, 0.0312187F),
            new SpectrumPeak(541, 0.0276887F),
            new SpectrumPeak(542, 0.0281418F),
            new SpectrumPeak(545, 0.0322642F),
            new SpectrumPeak(575, 0.0485882F),
            new SpectrumPeak(580, 0.0312453F),
            new SpectrumPeak(583, 0.0253113F),
            new SpectrumPeak(587, 0.0309323F),
            new SpectrumPeak(588, 0.0382717F),
            new SpectrumPeak(600, 0.0262768F),
            new SpectrumPeak(606, 0.0367926F),
            new SpectrumPeak(611, 0.0277356F),
            new SpectrumPeak(615, 0.0480343F),
            new SpectrumPeak(623, 0.0260899F),
            new SpectrumPeak(633, 0.0389418F),
            new SpectrumPeak(634, 0.0308692F),
            new SpectrumPeak(635, 0.0704129F),
            new SpectrumPeak(640, 0.0650674F),
            new SpectrumPeak(644, 0.0397831F),
            new SpectrumPeak(650, 0.0525732F),
            new SpectrumPeak(652, 0.0429642F),
            new SpectrumPeak(659, 0.0673001F),
            new SpectrumPeak(671, 0.0171379F),
            new SpectrumPeak(675, 0.0598465F),
            new SpectrumPeak(676, 0.0330063F),
            new SpectrumPeak(679, 0.0256366F),
            new SpectrumPeak(680, 0.0452853F),
            new SpectrumPeak(683, 0.0306833F),
            new SpectrumPeak(686, 0.0254502F),
            new SpectrumPeak(688, 0.0409625F),
            new SpectrumPeak(689, 0.0251403F),
            new SpectrumPeak(695, 0.0288817F),
            new SpectrumPeak(697, 0.0171888F),
            new SpectrumPeak(699, 0.0452803F),
            new SpectrumPeak(701, 0.0278847F),
            new SpectrumPeak(704, 0.0376008F),
            new SpectrumPeak(715, 0.0422678F),
            new SpectrumPeak(727, 0.048476F),
            new SpectrumPeak(733, 0.0275814F),
            new SpectrumPeak(734, 0.0728045F),
            new SpectrumPeak(735, 0.0452475F),
            new SpectrumPeak(737, 0.027996F),
            new SpectrumPeak(739, 0.0719857F),
            new SpectrumPeak(741, 0.0450002F),
            new SpectrumPeak(742, 0.0421935F),
            new SpectrumPeak(751, 0.0496244F),
            new SpectrumPeak(752, 0.0298543F),
            new SpectrumPeak(753, 0.0416209F),
            new SpectrumPeak(756, 0.098678F),
            new SpectrumPeak(757, 0.0470337F),
            new SpectrumPeak(773, 0.0297995F),
            new SpectrumPeak(774, 0.0214291F),
            new SpectrumPeak(779, 0.0172404F),
            new SpectrumPeak(782, 0.0185586F),
            new SpectrumPeak(789, 0.0251201F),
            new SpectrumPeak(791, 0.0319048F),
            new SpectrumPeak(793, 0.0657913F),
            new SpectrumPeak(796, 0.0510511F),
            new SpectrumPeak(798, 0.0207985F),
            new SpectrumPeak(800, 0.0158972F),
            new SpectrumPeak(801, 0.02218F),
            new SpectrumPeak(805, 0.0686336F),
            new SpectrumPeak(807, 0.045594F),
            new SpectrumPeak(809, 0.0155822F),
            new SpectrumPeak(811, 0.0184099F),
            new SpectrumPeak(816, 0.0103588F),
            new SpectrumPeak(817, 0.0116871F),
            new SpectrumPeak(824, 0.014134F),
            new SpectrumPeak(825, 0.0190665F),
            new SpectrumPeak(828, 0.0093422F),
            new SpectrumPeak(831, 0.0171447F),
            new SpectrumPeak(833, 0.0117929F),
            new SpectrumPeak(834, 0.0244148F),
            new SpectrumPeak(855, 0.0416534F),
            new SpectrumPeak(860, 0.0345135F),
            new SpectrumPeak(861, 0.016926F),
            new SpectrumPeak(866, 0.0142131F),
            new SpectrumPeak(867, 0.0242547F),
            new SpectrumPeak(869, 0.0342695F),
            new SpectrumPeak(870, 0.0193322F),
            new SpectrumPeak(879, 0.0365771F),
            new SpectrumPeak(883, 0.0176426F),
            new SpectrumPeak(885, 0.0242104F),
            new SpectrumPeak(887, 0.0124968F),
            new SpectrumPeak(902, 0.0179381F),
            new SpectrumPeak(909, 0.0547542F),
            new SpectrumPeak(910, 0.00834393F),
            new SpectrumPeak(913, 0.00525136F),
            new SpectrumPeak(917, 0.0409253F),
            new SpectrumPeak(919, 0.0133574F),
            new SpectrumPeak(922, 0.015454F),
            new SpectrumPeak(923, 0.0178742F),
            new SpectrumPeak(927, 0.0423277F),
            new SpectrumPeak(928, 0.0218377F),
            new SpectrumPeak(929, 0.0214689F),
            new SpectrumPeak(931, 0.0357837F),
            new SpectrumPeak(941, 0.00933563F),
            new SpectrumPeak(942, 0.0417363F),
            new SpectrumPeak(943, 0.0123998F),
            new SpectrumPeak(949, 0.0296709F),
            new SpectrumPeak(952, 0.0182056F),
            new SpectrumPeak(954, 0.00624797F),
            new SpectrumPeak(959, 0.102406F),
            new SpectrumPeak(961, 0.0167722F),
            new SpectrumPeak(962, 0.0318148F),
            new SpectrumPeak(964, 0.00996445F),
            new SpectrumPeak(965, 0.0107828F),
            new SpectrumPeak(980, 0.082741F),
            new SpectrumPeak(981, 0.0506797F),
            new SpectrumPeak(983, 0.0245908F),
            new SpectrumPeak(993, 0.0175175F),
            new SpectrumPeak(996, 0.0104282F),
            new SpectrumPeak(1009, 0.0203697F),
            new SpectrumPeak(1010, 0.00498157F),
            new SpectrumPeak(1012, 0.0398296F),
            new SpectrumPeak(1016, 0.0269647F),
            new SpectrumPeak(1025, 0.00976535F),
            new SpectrumPeak(1028, 0.0645582F),
            new SpectrumPeak(1029, 0.0255696F),
            new SpectrumPeak(1031, 0.0109482F),
            new SpectrumPeak(1033, 0.0109829F),
            new SpectrumPeak(1034, 0.0401495F),
            new SpectrumPeak(1037, 0.0260598F),
            new SpectrumPeak(1045, 0.0314769F),
            new SpectrumPeak(1046, 0.0838653F),
            new SpectrumPeak(1047, 0.0175395F),
            new SpectrumPeak(1048, 0.00580746F),
            new SpectrumPeak(1050, 0.0294616F),
            new SpectrumPeak(1051, 0.00515731F),
            new SpectrumPeak(1052, 0.0464293F),
            new SpectrumPeak(1055, 0.0277184F),
            new SpectrumPeak(1056, 0.0273172F),
            new SpectrumPeak(1057, 0.0308253F),
            new SpectrumPeak(1059, 0.0249594F),
            new SpectrumPeak(1061, 0.0358557F),
            new SpectrumPeak(1065, 0.0219811F),
            new SpectrumPeak(1066, 0.0304821F),
            new SpectrumPeak(1073, 0.00848577F),
            new SpectrumPeak(1076, 0.078208F),
            new SpectrumPeak(1077, 0.0786768F),
            new SpectrumPeak(1078, 0.0321174F),
            new SpectrumPeak(1079, 0.014771F),
            new SpectrumPeak(1086, 0.0192549F),
            new SpectrumPeak(1088, 0.0138996F),
            new SpectrumPeak(1131, 0.0486809F),
            new SpectrumPeak(1132, 0.0796151F),
            new SpectrumPeak(1133, 0.0558209F),
            new SpectrumPeak(1143, 0.102185F),
            new SpectrumPeak(1144, 0.0457825F),
            new SpectrumPeak(1152, 0.027558F),
            new SpectrumPeak(1162, 0.0157795F),
            new SpectrumPeak(1164, 0.0180585F),
            new SpectrumPeak(1194, 0.0272452F),
            new SpectrumPeak(1227, 0.0107283F),
            new SpectrumPeak(1230, 0.107707F),
            new SpectrumPeak(1231, 0.0294977F),
            new SpectrumPeak(1232, 0.0107815F),
            new SpectrumPeak(1240, 0.0190005F),
            new SpectrumPeak(1244, 0.0106628F),
            new SpectrumPeak(1260, 0.0355186F),
            new SpectrumPeak(1261, 0.0466365F),
            new SpectrumPeak(1262, 0.069609F),
            new SpectrumPeak(1263, 0.0293718F),
            new SpectrumPeak(1270, 0.0133874F),
            new SpectrumPeak(1272, 0.0173518F),
            new SpectrumPeak(1279, 0.0117172F),
            new SpectrumPeak(1282, 0.0117043F),
            new SpectrumPeak(1288, 0.0458725F),
            new SpectrumPeak(1308, 0.0827257F),
            new SpectrumPeak(1339, 0.0617024F),
            new SpectrumPeak(1346, 0.067121F),
            new SpectrumPeak(1357, 0.0728453F),
            new SpectrumPeak(1364, 0.0385267F),
            new SpectrumPeak(1367, 0.0850216F),
            new SpectrumPeak(1373, 0.0322007F),
            new SpectrumPeak(1375, 0.104092F),
            new SpectrumPeak(1385, 0.0889413F),
            new SpectrumPeak(1386, 0.0878377F),
            new SpectrumPeak(1416, 0.101993F),
            new SpectrumPeak(1418, 0.0304799F),
            new SpectrumPeak(1432, 0.10413F),
            new SpectrumPeak(1433, 0.0390129F),
            new SpectrumPeak(1436, 0.0802626F),
            new SpectrumPeak(1443, 0.040596F),
            new SpectrumPeak(1455, 0.0654885F),
            new SpectrumPeak(1456, 0.0760334F),
            new SpectrumPeak(1468, 0.0677982F),
            new SpectrumPeak(1487, 0.0825594F),
            new SpectrumPeak(1498, 0.0577441F),
            new SpectrumPeak(1531, 0.0774811F),
            new SpectrumPeak(1544, 0.0803543F),
            new SpectrumPeak(1552, 0.045572F),
            new SpectrumPeak(1559, 0.0511627F),
            new SpectrumPeak(1571, 0.0313677F),
            new SpectrumPeak(1573, 0.041835F),
            new SpectrumPeak(1582, 0.0399358F),
            new SpectrumPeak(1585, 0.0792004F),
            new SpectrumPeak(1597, 0.0461167F),
            new SpectrumPeak(1598, 0.0276646F),
            new SpectrumPeak(1601, 0.0539938F),
            new SpectrumPeak(1604, 0.0398563F),
            new SpectrumPeak(1615, 0.0682952F),
            new SpectrumPeak(1617, 0.0426595F),
            new SpectrumPeak(1655, 0.0529044F),
            new SpectrumPeak(1669, 0.0313289F),
            new SpectrumPeak(1671, 0.0454941F),
            new SpectrumPeak(1672, 0.0434517F),
            new SpectrumPeak(1679, 0.0540031F),
            new SpectrumPeak(1682, 0.0299844F),
            new SpectrumPeak(1696, 0.0354733F),
            new SpectrumPeak(1697, 0.104533F),
            new SpectrumPeak(1701, 0.0232356F),
            new SpectrumPeak(1705, 0.0333693F),
            new SpectrumPeak(1714, 0.0254622F),
            new SpectrumPeak(1717, 0.0349723F),
            new SpectrumPeak(1718, 0.0392792F),
            new SpectrumPeak(1724, 0.0297473F),
            new SpectrumPeak(1726, 0.0444385F),
            new SpectrumPeak(1728, 0.0338415F),
            new SpectrumPeak(1744, 0.0412419F),
            new SpectrumPeak(1750, 0.0486003F),
            new SpectrumPeak(1753, 0.0393539F),
            new SpectrumPeak(1771, 0.059177F),
            new SpectrumPeak(1777, 0.030797F),
            new SpectrumPeak(1778, 0.0326484F),
            new SpectrumPeak(1779, 0.0464055F),
            new SpectrumPeak(1782, 0.0308289F),
            new SpectrumPeak(1792, 0.0226508F),
            new SpectrumPeak(1793, 0.0366315F),
            new SpectrumPeak(1796, 0.035872F),
            new SpectrumPeak(1798, 0.0910536F),
            new SpectrumPeak(1815, 0.0718699F),
            new SpectrumPeak(1816, 0.0362676F),
            new SpectrumPeak(1819, 0.0331217F),
            new SpectrumPeak(1822, 0.0334853F),
            new SpectrumPeak(1830, 0.0318876F),
            new SpectrumPeak(1833, 0.0392255F),
            new SpectrumPeak(1836, 0.0366319F),
            new SpectrumPeak(1838, 0.0336278F),
            new SpectrumPeak(1841, 0.0731083F),
            new SpectrumPeak(1856, 0.0323443F),
            new SpectrumPeak(1857, 0.0551761F),
            new SpectrumPeak(1862, 0.0228074F),
            new SpectrumPeak(1864, 0.0608266F),
            new SpectrumPeak(1871, 0.0181227F),
            new SpectrumPeak(1879, 0.048838F),
            new SpectrumPeak(1885, 0.0379939F),
            new SpectrumPeak(1887, 0.0387857F),
            new SpectrumPeak(1889, 0.03441F),
            new SpectrumPeak(1892, 0.0382608F),
            new SpectrumPeak(1895, 0.0235506F),
            new SpectrumPeak(1896, 0.0216715F),
            new SpectrumPeak(1897, 0.0207387F),
            new SpectrumPeak(1899, 0.0399307F),
            new SpectrumPeak(1906, 0.0603155F),
            new SpectrumPeak(1908, 0.030776F),
            new SpectrumPeak(1914, 0.0340791F),
            new SpectrumPeak(1916, 0.0558767F),
            new SpectrumPeak(1919, 0.0530758F),
            new SpectrumPeak(1922, 0.0168614F),
            new SpectrumPeak(1923, 0.0276757F),
            new SpectrumPeak(1927, 0.0142747F),
            new SpectrumPeak(1928, 0.00714044F),
            new SpectrumPeak(1933, 0.0162216F),
            new SpectrumPeak(1934, 0.0151035F),
            new SpectrumPeak(1937, 0.0283729F),
            new SpectrumPeak(1938, 0.0334486F),
            new SpectrumPeak(1939, 0.0208251F),
            new SpectrumPeak(1941, 0.014208F),
            new SpectrumPeak(1942, 0.0279913F),
            new SpectrumPeak(1943, 0.00795898F),
            new SpectrumPeak(1944, 0.0144547F),
            new SpectrumPeak(1946, 0.0199967F),
            new SpectrumPeak(1947, 0.016392F),
            new SpectrumPeak(1949, 0.0128449F),
            new SpectrumPeak(1950, 0.0470561F),
            new SpectrumPeak(1951, 0.00276584F),
            new SpectrumPeak(1952, 0.00866427F),
            new SpectrumPeak(1954, 0.00456767F),
            new SpectrumPeak(1955, 0.0272536F),
            new SpectrumPeak(1960, 0.01573F),
            new SpectrumPeak(1961, 0.0354667F),
            new SpectrumPeak(1962, 0.0849873F),
            new SpectrumPeak(1964, 0.0183333F),
            new SpectrumPeak(1965, 0.0401911F),
            new SpectrumPeak(1970, 0.0119895F),
            new SpectrumPeak(1973, 0.0367673F),
            new SpectrumPeak(1974, 0.0456499F),
            new SpectrumPeak(1976, 0.0573477F),
            new SpectrumPeak(1977, 0.0165982F),
            new SpectrumPeak(1978, 0.0605717F),
            new SpectrumPeak(1980, 0.0506986F),
            new SpectrumPeak(1981, 0.0853388F),
            new SpectrumPeak(1983, 0.0534507F),
            new SpectrumPeak(1985, 0.071318F),
            new SpectrumPeak(1986, 0.0514652F),
            new SpectrumPeak(1987, 0.0727585F),
            new SpectrumPeak(1988, 0.0548705F),
            new SpectrumPeak(1990, 0.0247046F),
            new SpectrumPeak(1991, 0.0164396F),
            new SpectrumPeak(1992, 0.0165653F),
            new SpectrumPeak(1993, 0.0765376F),
            new SpectrumPeak(1994, 0.0379115F),
            new SpectrumPeak(1996, 0.0232485F),
    };

      @Test  //todo fix
    public void testScoringOutput() throws Exception
    {
        XTandemMain main = new XTandemMain(
                XTandemUtilities.getResourceStream("largeSample/tandem.params"),
                "largeSample/tandem.params");
//        if(!JXTandemTestConfiguration.isDatabaseAccessible(main))
//            return;
        main.loadScoringTest();
        main.loadSpectra();
        XTandemDebugging.setDebugging(true, main);
        File log = new File("log1.txt");
        if(!log.exists())
            return;
        XTandemDebugging.loadXTandemValues("log1.txt");
        Scorer scoreRunner = main.getScoreRunner();
        scoreRunner.score();

        final DebugValues dvLocal = XTandemDebugging.getLocalValues();
        DebugValues dvs = XTandemDebugging.getComparisonValues();
        final DebugDotProduct[] id = dvs.getDebugDotProductsWithId("7858");
        final DebugDotProduct product = dvs.getDebugDotProduct("7858:B");
        final ISpectrumPeak[] spectrumPeaks = product.getMeasuredPeaks();
        validateEquivalent(spectrumPeaks, XTANDEM_FINDS);
    }

    private void validateEquivalent(ISpectrumPeak[] peaks, SpectrumPeak[] finds) throws Exception
    {
          Assert.assertEquals(peaks.length,finds.length);
        for (int i = 0; i < Math.min(peaks.length, finds.length); i++) {
            ISpectrumPeak eak = peaks[i];
            ISpectrumPeak find = finds[i];
            try {
                validateEquivalentPeak(eak, find);
            }
            catch (AssertionError e) {
                throw e;
            }
        }

    }

    private void validateEquivalentPeak(ISpectrumPeak pEak, ISpectrumPeak pFind) throws Exception
    {
        Assert.assertEquals(pEak.getMassChargeRatio(), pFind.getMassChargeRatio(), 0.25);
        Assert.assertEquals(pEak.getPeak(), pFind.getPeak(), 0.001);


    }

}
